---
---
<script is:inline>
  function initLeaderboardSort() {
    const table = document.getElementById("leaderboardTable");
    if (!table) return;

    const tbody = table.tBodies[0];
    const buttons = table.querySelectorAll("button.sort-btn");

    let activeCol = null;
    let activeDir = "desc";

    function parseYM(s) {
      const m = String(s).trim().match(/^(\d{4})-(\d{2})$/);
      if (!m) return NaN;
      return Number(m[1]) * 100 + Number(m[2]);
    }

    function parseNum(s) {
      const t = String(s).trim();
      if (!t || t === "-" || t === "–") return NaN;
      const v = Number(t);
      return Number.isFinite(v) ? v : NaN;
    }

    function parseStr(s) {
      return String(s).trim().toLowerCase();
    }

    function getCellValue(row, col, type) {
      const cell = row.cells[col];
      const txt = cell ? cell.textContent : "";
      if (type === "ym") return parseYM(txt);
      if (type === "num") return parseNum(txt);
      return parseStr(txt);
    }

    function comparator(col, type, dir) {
      const sign = dir === "asc" ? 1 : -1;

      return (a, b) => {
        const va = getCellValue(a, col, type);
        const vb = getCellValue(b, col, type);

        const aNa = type !== "str" && Number.isNaN(va);
        const bNa = type !== "str" && Number.isNaN(vb);

        if (aNa && bNa) return 0;
        if (aNa) return 1;
        if (bNa) return -1;

        if (type === "str") {
          if (va === vb) return 0;
          return va > vb ? sign : -sign;
        } else {
          if (va === vb) return 0;
          return (va - vb) * sign;
        }
      };
    }

    function collectGroups() {
      const rows = Array.from(tbody.rows);
      const groups = [];
      let cur = null;

      for (const r of rows) {
        if (r.classList.contains("group-row")) {
          cur = { header: r, items: [] };
          groups.push(cur);
        } else {
          if (!cur) {
            cur = { header: null, items: [] };
            groups.push(cur);
          }
          cur.items.push(r);
        }
      }
      return groups;
    }

    function rerender(groups) {
      const frag = document.createDocumentFragment();
      for (const g of groups) {
        if (g.header) frag.appendChild(g.header);
        for (const r of g.items) frag.appendChild(r);
      }
      tbody.innerHTML = "";
      tbody.appendChild(frag);
    }

    function updateIndicators(col, dir) {
      table.querySelectorAll("th[aria-sort]").forEach((th) => th.setAttribute("aria-sort", "none"));
      table.querySelectorAll(".sort-indicator").forEach((el) => (el.textContent = ""));

      const btn = table.querySelector('button.sort-btn[data-col="' + col + '"]');
      if (!btn) return;

      const th = btn.closest("th");
      if (th) th.setAttribute("aria-sort", dir === "asc" ? "ascending" : "descending");

      const ind = btn.querySelector(".sort-indicator");
      if (ind) ind.textContent = dir === "asc" ? "↑" : "↓";
    }

    function sortBy(col, type) {
      if (activeCol === col) activeDir = activeDir === "asc" ? "desc" : "asc";
      else {
        activeCol = col;
        activeDir = "desc";
      }

      const groups = collectGroups();
      for (const g of groups) g.items.sort(comparator(col, type, activeDir));
      rerender(groups);
      updateIndicators(col, activeDir);
    }

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const col = Number(btn.dataset.col);
        const type = btn.dataset.type || "num";
        sortBy(col, type);
      });
    });

    sortBy(2, "num");
  }

  // 确保 table 已经在 DOM 里
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initLeaderboardSort);
  } else {
    initLeaderboardSort();
  }
</script>
