<script is:inline>
  function initLeaderboardSort() {
    const table = document.getElementById("leaderboardTable");
    if (!table) return;

    const tbody = table.tBodies[0];
    const buttons = table.querySelectorAll("button.sort-btn");

    let activeCol = null;
    let activeDir = "desc";

    // ✅ 如果你忘了删 group-row，这里也会自动清掉（可保留，防呆）
    tbody.querySelectorAll("tr.group-row").forEach((r) => r.remove());

    function parseYM(s) {
      const m = String(s).trim().match(/^(\d{4})-(\d{2})$/);
      if (!m) return NaN;
      return Number(m[1]) * 100 + Number(m[2]);
    }

    function parseNum(s) {
      const t = String(s).trim();
      if (!t || t === "-" || t === "–") return NaN;
      const v = Number(t);
      return Number.isFinite(v) ? v : NaN;
    }

    function parseStr(s) {
      return String(s).trim().toLowerCase();
    }

    function getCellValue(row, col, type) {
      const cell = row.cells[col];
      const txt = cell ? cell.textContent : "";
      if (type === "ym") return parseYM(txt);
      if (type === "num") return parseNum(txt);
      return parseStr(txt);
    }

    function comparator(col, type, dir) {
      const sign = dir === "asc" ? 1 : -1;

      return (a, b) => {
        const va = getCellValue(a, col, type);
        const vb = getCellValue(b, col, type);

        const aNa = type !== "str" && Number.isNaN(va);
        const bNa = type !== "str" && Number.isNaN(vb);

        // NaN 永远放最后
        if (aNa && bNa) return 0;
        if (aNa) return 1;
        if (bNa) return -1;

        if (type === "str") {
          if (va === vb) return 0;
          return va > vb ? sign : -sign;
        } else {
          if (va === vb) return 0;
          return (va - vb) * sign;
        }
      };
    }

    function updateIndicators(col, dir) {
      table.querySelectorAll("th[aria-sort]").forEach((th) => th.setAttribute("aria-sort", "none"));
      table.querySelectorAll(".sort-indicator").forEach((el) => (el.textContent = ""));

      const btn = table.querySelector('button.sort-btn[data-col="' + col + '"]');
      if (!btn) return;

      const th = btn.closest("th");
      if (th) th.setAttribute("aria-sort", dir === "asc" ? "ascending" : "descending");

      const ind = btn.querySelector(".sort-indicator");
      if (ind) ind.textContent = dir === "asc" ? "↑" : "↓";
    }

    // ✅ 给每行一个原始顺序，用来稳定排序（同分时不乱跳）
    function ensureOrigIndex(rows) {
      rows.forEach((r, i) => {
        if (!r.dataset.orig) r.dataset.orig = String(i);
      });
    }

    function sortBy(col, type) {
      if (activeCol === col) activeDir = activeDir === "asc" ? "desc" : "asc";
      else {
        activeCol = col;
        activeDir = "desc";
      }

      const rows = Array.from(tbody.rows); // 现在只有数据行了
      ensureOrigIndex(rows);

      const cmp = comparator(col, type, activeDir);
      rows.sort((a, b) => {
        const r = cmp(a, b);
        if (r !== 0) return r;
        return Number(a.dataset.orig) - Number(b.dataset.orig);
      });

      const frag = document.createDocumentFragment();
      rows.forEach((r) => frag.appendChild(r));
      tbody.replaceChildren(frag);

      updateIndicators(col, activeDir);
    }

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const col = Number(btn.dataset.col);
        const type = btn.dataset.type || "num";
        sortBy(col, type);
      });
    });

    // 默认按 Acc_p 降序
    sortBy(2, "num");
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initLeaderboardSort);
  } else {
    initLeaderboardSort();
  }
</script>
